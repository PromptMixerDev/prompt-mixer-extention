# Документация по рефакторингу инжекторов

## Обзор

В рамках оптимизации проекта Prompt Mixer Extension был проведен рефакторинг инжекторов для улучшения модульности, производительности и поддерживаемости кода. Основные цели рефакторинга:

1. **Модуляризация кода** - разделение больших классов на более мелкие, специализированные модули
2. **Улучшение производительности** - оптимизация DOM-операций и обработки событий
3. **Улучшение логирования** - внедрение структурированного логирования с уровнями
4. **Предотвращение утечек памяти** - правильное отслеживание и удаление обработчиков событий

## Новая структура кода

### Утилиты

Были созданы следующие утилиты:

1. **AuthManager** (`auth-manager.ts`)
   - Управление аутентификацией пользователя
   - Проверка статуса аутентификации

2. **NavigationManager** (`navigation-manager.ts`)
   - Отслеживание изменений URL
   - Обработка событий навигации в SPA

3. **InputFieldManager** (`input-field-manager.ts`)
   - Поиск полей ввода
   - Получение и установка текста в поля ввода
   - Настройка обработчиков событий для полей ввода

4. **LogManager** (`log-manager.ts`)
   - Структурированное логирование с уровнями (DEBUG, INFO, WARN, ERROR)
   - Контекстная информация в логах
   - Создание логгеров для разных компонентов

5. **EventTracker** (`event-tracker.ts`)
   - Отслеживание добавленных обработчиков событий
   - Правильное удаление обработчиков событий
   - Предотвращение утечек памяти

6. **DOMCache** (`dom-cache.ts`)
   - Кэширование результатов DOM-запросов
   - Улучшение производительности за счет уменьшения количества DOM-операций
   - Статистика использования кэша

### Инжекторы

Были рефакторинговые версии инжекторов:

1. **BaseInjector** (`base-injector-refactored.ts`)
   - Базовый класс для всех инжекторов
   - Использует новые утилиты для общей функциональности
   - Абстрактный метод `isUrlSupported()` для проверки поддержки URL

2. **GPTInjector** (`gpt-injector-refactored.ts`)
   - Инжектор для ChatGPT
   - Расширенные селекторы для разных версий интерфейса
   - Увеличенное время ожидания для наблюдателя DOM

3. **ClaudeInjector** (`claude-injector-refactored.ts`)
   - Инжектор для Claude
   - Специфичные селекторы для Claude
   - Обработка событий аутентификации

4. **InjectorFactory** (`injector-factory-refactored.ts`)
   - Фабрика для создания инжекторов
   - Определение типа страницы
   - Создание соответствующего инжектора

5. **ContentScript** (`content-script-refactored.ts`)
   - Точка входа для контент-скриптов
   - Инициализация логгера
   - Создание и инициализация инжектора

## Основные улучшения

### 1. Модуляризация кода

Код был разделен на более мелкие, специализированные модули, что улучшает:
- **Читаемость** - каждый модуль имеет четкую ответственность
- **Тестируемость** - модули можно тестировать независимо
- **Поддерживаемость** - изменения в одном модуле не влияют на другие

### 2. Улучшение производительности

Были внедрены следующие оптимизации:
- **Кэширование DOM-запросов** - уменьшение количества обращений к DOM
- **Оптимизация селекторов** - более специфичные селекторы для разных платформ
- **Делегирование событий** - уменьшение количества обработчиков событий

### 3. Улучшение логирования

Было внедрено структурированное логирование:
- **Уровни логирования** - DEBUG, INFO, WARN, ERROR
- **Контекстная информация** - имя компонента, URL, дополнительные данные
- **Группировка логов** - логические группы для связанных сообщений

### 4. Предотвращение утечек памяти

Были внедрены механизмы для предотвращения утечек памяти:
- **Отслеживание обработчиков событий** - все обработчики событий отслеживаются
- **Правильное удаление обработчиков** - все обработчики удаляются при очистке
- **Очистка ресурсов** - все ресурсы освобождаются при выгрузке страницы

## Как использовать новый код

### Переход на новый код

Для перехода на новый код необходимо:

1. Заменить импорты в `content-script.ts`:
   ```typescript
   // Было
   import { createInjector, detectPageType, InjectorType } from './injectors/injector-factory';

   // Стало
   import { createInjector, detectPageType, InjectorType } from './injectors/injector-factory-refactored';
   ```

2. Или переименовать файлы:
   ```bash
   mv base-injector-refactored.ts base-injector.ts
   mv gpt-injector-refactored.ts gpt-injector.ts
   mv claude-injector-refactored.ts claude-injector.ts
   mv injector-factory-refactored.ts injector-factory.ts
   mv content-script-refactored.ts content-script.ts
   ```

### Добавление нового инжектора

Для добавления нового инжектора:

1. Создать новый класс, наследующийся от `BaseInjector`:
   ```typescript
   export class NewInjector extends BaseInjector {
     constructor(config: Partial<InjectorConfig> = {}) {
       super({
         name: 'New',
         inputSelector: '...',
         buttonStyle: 'default',
         ...config,
       });
     }

     public isUrlSupported(): boolean {
       return NavigationManager.urlMatches('example.com');
     }
   }
   ```

2. Добавить инжектор в фабрику:
   ```typescript
   export function createInjector(): BaseInjector | null {
     // ...
     const newInjector = new NewInjector();
     
     if (newInjector.isUrlSupported()) {
       return newInjector;
     }
     // ...
   }
   ```

## Тестирование

Для тестирования нового кода:

1. Собрать расширение:
   ```bash
   cd frontend
   npm run build
   ```

2. Установить расширение в браузер:
   - Откройте Chrome и перейдите на страницу `chrome://extensions/`
   - Включите "Режим разработчика" (Developer mode)
   - Нажмите "Загрузить распакованное расширение" (Load unpacked)
   - Выберите директорию `frontend/dist`

3. Проверить работу на разных сайтах:
   - Claude (claude.ai, anthropic.com)
   - ChatGPT (chat.openai.com, chatgpt.com)
   - OpenAI (openai.com)

## Дальнейшие улучшения

Возможные направления для дальнейших улучшений:

1. **Добавление автоматических тестов**:
   - Модульные тесты для утилит
   - Интеграционные тесты для инжекторов

2. **Улучшение обработки ошибок**:
   - Централизованная обработка ошибок
   - Отправка ошибок на сервер для анализа

3. **Улучшение пользовательского опыта**:
   - Анимации и переходы для кнопок
   - Настройки для пользователя (стиль, положение кнопки)

4. **Оптимизация размера бандла**:
   - Анализ и оптимизация зависимостей
   - Использование tree-shaking для удаления неиспользуемого кода
